<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Learning Portal</title>

  <!-- App SDKs (no build tools) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    :root{
      --bg:#f6f7f9; --card:#ffffff; --text:#111827; --muted:#6b7280; --border:#e5e7eb; --accent:#2563eb;
      --nav:#ffffff; --shadow: 0 8px 25px rgba(17,24,39,.06); --radius:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    html[data-theme="dark"]{
      --bg:#0b1220; --card:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --border:#1f2a44; --accent:#60a5fa;
      --nav:#0f172a; --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:var(--sans);background:var(--bg);color:var(--text)}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .topbar{position:sticky;top:0;z-index:30;background:var(--nav);border-bottom:1px solid var(--border);backdrop-filter:saturate(180%) blur(10px)}
    .nav{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 18px;max-width:1100px;margin:0 auto}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.2px}
    .badge{font-family:var(--mono);font-size:12px;padding:3px 8px;border:1px solid var(--border);border-radius:999px;color:var(--muted)}
    .navlinks{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .tab{border:1px solid var(--border);background:transparent;color:var(--text);padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:650;font-size:13px}
    .tab.active{background:rgba(37,99,235,.12);border-color:rgba(37,99,235,.35)}
    .tab:disabled{opacity:.45;cursor:not-allowed}
    .right{display:flex;align-items:center;gap:10px}
    .userpill{display:flex;align-items:center;gap:8px;border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:13px;color:var(--muted)}
    .pill{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:3px 8px;font-size:12px;color:var(--muted);font-family:var(--mono)}
    .btn{border:1px solid var(--border);background:var(--card);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700}
    .btn.primary{border-color:rgba(37,99,235,.45);background:rgba(37,99,235,.12)}
    .btn.danger{border-color:rgba(239,68,68,.45);background:rgba(239,68,68,.10)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .grid{display:grid;grid-template-columns:320px 1fr;gap:14px;margin-top:14px}
    @media (max-width: 920px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
    .card h2,.card h3{margin:0 0 10px 0}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .mono{font-family:var(--mono)}
    .input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--text);outline:none}
    .row{display:flex;gap:10px}
    .row>*{flex:1}
    .divider{height:1px;background:var(--border);margin:12px 0}
    .views>section{display:none}
    .views>section.active{display:block}
    .list{display:flex;flex-direction:column;gap:8px}
    .item{border:1px solid var(--border);border-radius:12px;padding:10px 12px;background:transparent}
    .item.clickable{cursor:pointer}
    .item.clickable:hover{border-color:rgba(37,99,235,.35)}
    .item .title{font-weight:800}
    .item .desc{color:var(--muted);font-size:12px;margin-top:2px}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .chatbox{height:340px;overflow:auto;border:1px solid var(--border);border-radius:12px;padding:10px;background:transparent}
    .msg{padding:8px 10px;border-radius:10px;border:1px solid var(--border);margin-bottom:8px}
    .msg .meta{font-size:12px;color:var(--muted);display:flex;justify-content:space-between;gap:10px}
    .msg .text{margin-top:6px;white-space:pre-wrap}
    footer{margin:22px 0 40px;text-align:center;color:var(--muted);font-size:12px}
    .dangerText{color:#ef4444}
  </style>
</head>

<body>
  <div class="topbar" id="topbar" style="display:none;">
    <div class="nav">
      <div class="brand">
        <span>Learning Portal</span>
        <span class="badge" id="roleBadge">—</span>
      </div>

      <div class="navlinks">
        <button class="tab" data-view="homeView" id="tabHome">Home</button>
        <button class="tab" data-view="resourcesView" id="tabResources">Study Resources</button>
        <button class="tab" data-view="utilitiesView" id="tabUtilities">Utilities</button>
        <button class="tab" data-view="memberChatView" id="tabMemberChat">Member Chat</button>
        <button class="tab" data-view="staffChatView" id="tabStaffChat">Staff Chat</button>
        <button class="tab" data-view="calendarView" id="tabCalendar">Calendar</button>
        <button class="tab" data-view="adminView" id="tabAdmin">Admin</button>
        <button class="tab" data-view="settingsView" id="tabSettings">Settings</button>
      </div>

      <div class="right">
        <div class="userpill">
          <span id="userAlias">Guest</span>
          <span class="pill" id="userEmail">—</span>
        </div>
        <button class="btn" id="btnSignOut">Sign out</button>
      </div>
    </div>
  </div>

  <div class="wrap">

    <div class="card" id="authCard">
      <h2>Sign in</h2>
      <p class="muted">Use the email/password account an admin created for you.</p>

      <div class="row">
        <div>
          <label class="small muted">Email</label>
          <input class="input" id="email" type="email" placeholder="you@example.com" autocomplete="username" />
        </div>
        <div>
          <label class="small muted">Password</label>
          <input class="input" id="password" type="password" placeholder="••••••••" autocomplete="current-password" />
        </div>
      </div>

      <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;">
        <button class="btn primary" id="btnLogin">Sign in</button>
</div>

      <div class="divider"></div>
      <p class="small" id="authMsg"></p>
</div>

    <div class="grid" id="appGrid" style="display:none;">
      <div class="card">
        <h3>Overview</h3>
        <div class="list">
          <div class="item">
            <div class="title">Users</div>
            <div class="desc"><span id="ovUsers">—</span> total</div>
          </div>
          <div class="item">
            <div class="title">Top Link</div>
            <div class="desc" id="ovTopLink">—</div>
          </div>
          <div class="item">
            <div class="title">Mod Actions</div>
            <div class="desc"><span id="ovModActions">—</span> logged</div>
          </div>
        </div>

        <div class="divider"></div>
        <p class="small muted">
          <b>Instant punish:</b> This app listens to your <span class="mono">users/{uid}</span> doc live.
          If staff suspends/bans you, you get kicked out or chat-disabled immediately.
        </p>
      </div>

      <div class="views">
        <section id="homeView" class="card active">
          <h2>Home</h2>
          <p class="muted">Welcome. Use the tabs to navigate.</p>
        </section>

        <section id="resourcesView" class="card">
          <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:10px; flex-wrap:wrap;">
            <div>
              <h2 style="margin-bottom:4px;">Study Resources</h2>
              <p class="muted" style="margin:0;">Pick a category to open its links.</p>
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button class="btn primary" id="btnAddCategory" style="display:none;">Add category</button>
            </div>
          </div>

          <div class="divider"></div>

          <div id="resourcesList" class="list"></div>

          <div class="divider"></div>

          <div id="resourceDetail" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:10px; flex-wrap:wrap;">
              <div>
                <h3 id="resourceTitle" style="margin-bottom:4px;">Category</h3>
                <div class="muted small" id="resourceMeta"></div>
              </div>
              <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button class="btn" id="btnBackToResources">Back</button>
                <button class="btn primary" id="btnAddLink" style="display:none;">Add link</button>
                <button class="btn danger" id="btnDeleteCategory" style="display:none;">Delete category</button>
              </div>
            </div>
            <div class="divider"></div>
            <div id="resourceLinks" class="list"></div>
          </div>
        </section>

        <section id="utilitiesView" class="card">
          <h2>Utilities</h2>
          <p class="muted">Standalone tools and links.</p>
          <div class="divider"></div>
          <div id="utilitiesList" class="list"></div>
          <div class="divider"></div>
          <button class="btn primary" id="btnAddUtility" style="display:none;">Add utility</button>
        </section>

        <section id="memberChatView" class="card">
          <h2>Member Chat</h2>
          <p class="muted">Your name in chat is your <b>alias</b>.</p>
          <div class="divider"></div>
          <div class="chatbox" id="memberChatBox"></div>
          <div class="divider"></div>
          <div class="row">
            <input class="input" id="memberChatInput" placeholder="Message..." maxlength="600" />
            <button class="btn primary" id="btnSendMember">Send</button>
          </div>
          <p class="small muted" id="memberChatNotice"></p>
        </section>

        <section id="staffChatView" class="card">
          <h2>Staff Chat</h2>
          <p class="muted">Visible to contributors+.</p>
          <div class="divider"></div>
          <div class="chatbox" id="staffChatBox"></div>
          <div class="divider"></div>
          <div class="row">
            <input class="input" id="staffChatInput" placeholder="Staff message..." maxlength="600" />
            <button class="btn primary" id="btnSendStaff">Send</button>
          </div>
          <p class="small muted" id="staffChatNotice"></p>
        </section>

        <section id="calendarView" class="card">
          <h2>Calendar</h2>
          <p class="muted">Events loaded from the calendar database.</p>
          <div class="divider"></div>
          <div id="eventsList" class="list"></div>
          <div class="divider"></div>
          <button class="btn primary" id="btnAddEvent" style="display:none;">Add event</button>
        </section>

        <section id="adminView" class="card">
          <h2>Admin Panel</h2>
          <p class="muted small">
            <b>Key rule:</b> Only <b>admin</b> can moderate staff.
            Co-admin/manager can moderate <b>members only</b>.
          </p>
          <div class="divider"></div>

          <div id="adminLocked" class="card" style="box-shadow:none;">
            <h3>Not authorized</h3>
            <p class="muted">You don’t have permission to use admin tools.</p>
          </div>

          <div id="adminTools" style="display:none;">
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button class="btn" id="btnAdminRefresh">Refresh panel</button>
              <button class="btn" id="btnHardReload">Hard reload</button>
            </div>

            <div class="divider"></div>
            <div class="card" style="box-shadow:none;">
              <h3>Top clicks</h3>
              <div id="statsList" class="list"></div>
            </div>

            <div class="divider"></div>
            <h3>User moderation</h3>
            <div id="usersList" class="list"></div>

            <div class="divider"></div>
            <h3>Mod logs</h3>
            <div id="modLogs" class="list"></div>
          </div>
        </section>

        <section id="settingsView" class="card">
          <h2>Settings</h2>

          <div class="divider"></div>

          <h3>Theme</h3>
          <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
            <button class="btn" id="btnThemeAuto">Auto</button>
            <button class="btn" id="btnThemeLight">Light</button>
            <button class="btn" id="btnThemeDark">Dark</button>
            <span class="small muted" id="themeStatus"></span>
          </div>

          <div class="divider"></div>

          <h3>Safe redirect</h3>
          <p class="small muted">Optional: when you sign out, redirect to a URL.</p>
          <div class="row">
            <input class="input" id="safeRedirectUrl" placeholder="https://example.com" />
            <button class="btn danger" id="btnQuickLogout">Sign out &amp; Redirect</button>
          </div>
        </section>
      </div>
    </div>

    <footer id="footer" style="display:none;">
      <div>Learning Portal • client-side</div>
    </footer>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCBj78TuU8hviaYMILXkXIzNtU8yIgk39c",
      authDomain: "learning-resources-2026.firebaseapp.com",
      projectId: "learning-resources-2026",
      storageBucket: "learning-resources-2026.firebasestorage.app",
      messagingSenderId: "67701812368",
      appId: "1:67701812368:web:d6ad7089316cdc66347c15",
      measurementId: "G-K867JHELDB"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

    const $ = (id) => document.getElementById(id);

    const OWNER_UID = "BEz5gSlOjOhMJVbalAONPZspvus1";
    const ROLE_RANK = { "member":0, "contributor":1, "manager":2, "co-admin":3, "admin":4 };
    function normRole(r){ return String(r || "member").toLowerCase().trim(); }
    function rankOf(r){ return ROLE_RANK[normRole(r)] ?? 0; }
    function isStaffRole(r){ return rankOf(r) >= rankOf("contributor"); }
    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }
    function nowMs(){ return Date.now(); }
    function tsToMs(ts){ try{ return ts?.toDate ? ts.toDate().getTime() : null; }catch{ return null; } }
    function isActiveUntil(ts){ const ms = tsToMs(ts); return ms && ms > nowMs(); }
    function addDays(d){ return new Date(Date.now() + d*24*60*60*1000); }
    function fmtTime(ts){ try{ const d = ts?.toDate ? ts.toDate() : null; return d ? d.toLocaleString() : ""; }catch{ return ""; } }

    function canModerateTarget(actorUid, actorRole, targetUid, targetRole){
      actorRole = normRole(actorRole);
      targetRole = normRole(targetRole);
      if (actorRole === "contributor") return false;
      if (targetUid === OWNER_UID && actorUid !== OWNER_UID) return false;
      if (rankOf(targetRole) >= rankOf(actorRole)) return false;
      if (isStaffRole(targetRole)) return (actorRole === "admin"); // staff => ONLY admin
      return (actorRole === "admin" || actorRole === "co-admin" || actorRole === "manager"); // members
    }
    function canBan(actorRole){ return normRole(actorRole) === "admin"; }
    function canChangeRole(actorRole){ return normRole(actorRole) === "admin"; }
    function maxSuspendDays(actorRole){
      actorRole = normRole(actorRole);
      if (actorRole === "admin") return 365;
      if (actorRole === "manager" || actorRole === "co-admin") return 7;
      return 0;
    }

    const authCard = $("authCard");
    const appGrid = $("appGrid");
    const topbar = $("topbar");
    const footer = $("footer");
    const authMsg = $("authMsg");

    const roleBadge = $("roleBadge");
    const userAliasEl = $("userAlias");
    const userEmailEl = $("userEmail");

    const tabs = Array.from(document.querySelectorAll(".tab"));
    const sections = Array.from(document.querySelectorAll(".views > section"));

    function setAuthMessage(msg, isError=false){
      authMsg.textContent = msg || "";
      authMsg.className = "small " + (isError ? "dangerText" : "");
    }
    function setView(viewId){
      sections.forEach(s => s.classList.toggle("active", s.id === viewId));
      tabs.forEach(t => t.classList.toggle("active", t.dataset.view === viewId));
      window.scrollTo({ top: 0, behavior: "smooth" });
    }
    tabs.forEach(t => t.addEventListener("click", () => { if(!t.disabled) setView(t.dataset.view); }));

    function setSignedInUI(on){
      authCard.style.display = on ? "none" : "block";
      appGrid.style.display = on ? "grid" : "none";
      topbar.style.display = on ? "block" : "none";
      footer.style.display = on ? "block" : "none";
    }

    const themeStatus = $("themeStatus");
    const safeRedirectUrl = $("safeRedirectUrl");
    let currentThemeMode = "auto";
    function systemPrefersDark(){ return window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches; }
    function applyTheme(mode){
      currentThemeMode = mode;
      if (mode === "auto"){
        document.documentElement.removeAttribute("data-theme");
        if (systemPrefersDark()) document.documentElement.setAttribute("data-theme","dark");
        themeStatus.textContent = "Following system";
      } else {
        document.documentElement.setAttribute("data-theme", mode);
        themeStatus.textContent = "Theme: " + mode;
      }
    }
    if (window.matchMedia){
      window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", () => {
        if (currentThemeMode === "auto") applyTheme("auto");
      });
    }
    async function loadSettings(uid){
      const ref = db.collection("settings").doc(uid);
      const snap = await ref.get();
      const s = snap.exists ? snap.data() : {};
      applyTheme(s.theme || "auto");
      safeRedirectUrl.value = s.safeRedirectUrl || "";
    }
    async function saveSettings(uid, partial){
      const ref = db.collection("settings").doc(uid);
      await ref.set(Object.assign({}, partial, {
        safeRedirectUrl: (safeRedirectUrl.value || "").trim(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }), { merge:true });
      if (partial.theme) applyTheme(partial.theme);
    }

    $("btnThemeAuto").addEventListener("click", () => currentUser && saveSettings(currentUser.uid, { theme:"auto" }));
    $("btnThemeLight").addEventListener("click", () => currentUser && saveSettings(currentUser.uid, { theme:"light" }));
    $("btnThemeDark").addEventListener("click", () => currentUser && saveSettings(currentUser.uid, { theme:"dark" }));
    $("btnQuickLogout").addEventListener("click", async () => {
      const url = (safeRedirectUrl.value || "").trim();
      try{ await auth.signOut(); }catch(e){}
      if (url) window.location.href = url;
    });

    $("btnLogin").addEventListener("click", async () => {
      const email = $("email").value.trim();
      const password = $("password").value;
      if (!email || !password) return setAuthMessage("Enter email and password.", true);
      setAuthMessage("Signing in...");
      try{ await auth.signInWithEmailAndPassword(email, password); setAuthMessage(""); }
      catch(e){ setAuthMessage(e.message || "Sign in failed.", true); }
    });
          if (!email) return setAuthMessage("Enter your email first.", true);
      setAuthMessage("Sending reset email...");
      try{ await auth.sendPasswordResetEmail(email); setAuthMessage("Reset email sent."); }
      catch(e){ setAuthMessage(e.message || "Reset failed.", true); }
    });
    $("btnSignOut").addEventListener("click", () => auth.signOut());

    let currentUser = null;
    let currentUserDoc = null;
    let unsubMemberChat = null;
    let unsubStaffChat = null;
    let unsubSelfDoc = null;
    let activeBrandId = null;

    function clearAll(){
      $("resourcesList").innerHTML = "";
      $("resourceLinks").innerHTML = "";
      $("utilitiesList").innerHTML = "";
      $("eventsList").innerHTML = "";
      $("memberChatBox").innerHTML = "";
      $("staffChatBox").innerHTML = "";
      $("usersList").innerHTML = "";
      $("statsList").innerHTML = "";
      $("modLogs").innerHTML = "";
    }

    async function ensureUserDoc(user){
      const ref = db.collection("users").doc(user.uid);
      const snap = await ref.get();
      if (!snap.exists){
        await ref.set({
          email: user.email || "",
          alias: (user.email || "user").split("@")[0],
          role: "member",
          banned: false,
          disabledUntil: null,
          chatSuspendedUntil: null,
          warnings: 0,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });
      }
      return ref;
    }

    function canUseStaffChat(){ return rankOf(normRole(currentUserDoc?.role)) >= rankOf("contributor"); }
    function canUseAdmin(){ const r = normRole(currentUserDoc?.role); return (r === "admin" || r === "co-admin" || r === "manager"); }
    function canEditContent(){ return rankOf(normRole(currentUserDoc?.role)) >= rankOf("contributor"); }
    function isAdmin(){ return normRole(currentUserDoc?.role) === "admin"; }

    function setTabsForRole(){
      $("tabStaffChat").disabled = !canUseStaffChat();
      $("tabAdmin").disabled = !canUseAdmin();

      $("btnAddLink").style.display = canEditContent() ? "inline-block" : "none";
      $("btnAddUtility").style.display = canEditContent() ? "inline-block" : "none";
      $("btnAddEvent").style.display = canEditContent() ? "inline-block" : "none";
      $("btnAddCategory").style.display = canEditContent() ? "inline-block" : "none";
      $("btnDeleteCategory").style.display = isAdmin() ? "inline-block" : "none";

      $("adminLocked").style.display = canUseAdmin() ? "none" : "block";
      $("adminTools").style.display = canUseAdmin() ? "block" : "none";
    }

    async function applyAccountRestrictions(){
      if (!currentUserDoc) return;
      if (currentUserDoc.banned){
        alert("This account is banned.");
        await auth.signOut(); return;
      }
      if (isActiveUntil(currentUserDoc.disabledUntil)){
        alert("This account is suspended until: " + currentUserDoc.disabledUntil.toDate().toLocaleString());
        await auth.signOut(); return;
      }
    }

    function slugifyName(name){
      return String(name || "").toLowerCase().replace(/['’]/g,"").replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"").slice(0,80) || ("cat-" + Date.now());
    }

    async function loadBrands(){
      const list = $("resourcesList");
      list.innerHTML = "";
      $("resourceDetail").style.display = "none";
      $("resourcesList").style.display = "flex";

      const snap = await db.collection("brands").orderBy("name").get();
      if (snap.empty){ list.innerHTML = `<div class="muted small">No categories yet.</div>`; return; }

      snap.forEach(doc => {
        const d = doc.data();
        const el = document.createElement("div");
        el.className = "item clickable";
        el.innerHTML = `<div class="title">${escapeHtml(d.name || doc.id)}</div><div class="desc">${escapeHtml(d.description || "Open to view links")}</div>`;
        el.addEventListener("click", () => openBrand(doc.id));
        list.appendChild(el);
      });
    }

    async function openBrand(brandId){
      activeBrandId = brandId;
      const ref = db.collection("brands").doc(brandId);
      const snap = await ref.get();
      const d = snap.exists ? snap.data() : {};
      $("resourceTitle").textContent = d.name || brandId;
      $("resourceMeta").textContent = d.description || "";
      $("resourceDetail").style.display = "block";
      $("resourcesList").style.display = "none";

      const links = Array.isArray(d.links) ? d.links : [];
      const container = $("resourceLinks");
      container.innerHTML = "";
      if (!links.length){ container.innerHTML = `<div class="muted small">No links here yet.</div>`; return; }

      links.forEach((link, idx) => {
        const title = link.title || ("Link " + (idx+1));
        const url = link.url || "";
        const desc = link.desc || "";

        const el = document.createElement("div");
        el.className = "item clickable";
        el.innerHTML = `<div class="title">${escapeHtml(title)}</div><div class="desc">${escapeHtml(desc || url)}</div>`;
        el.addEventListener("click", async () => {
          await trackClick(`brand:${brandId}:${idx}`, { brandId, title, url });
          if (url) window.open(url, "_blank", "noopener,noreferrer");
        });

        if (canEditContent()){
          const actions = document.createElement("div");
          actions.className = "actions";

          const btnEdit = document.createElement("button");
          btnEdit.className = "btn";
          btnEdit.textContent = "Edit";
          btnEdit.addEventListener("click", async (e) => {
            e.stopPropagation();
            const t = prompt("Edit title", title); if (t === null) return;
            const u = prompt("Edit URL", url); if (u === null) return;
            const ds = prompt("Edit description", desc); if (ds === null) return;

            await db.runTransaction(async (tx) => {
              const s = await tx.get(ref);
              const dd = s.exists ? s.data() : {};
              const arr = Array.isArray(dd.links) ? dd.links : [];
              if (!arr[idx]) return;
              arr[idx] = { title:t, url:u, desc:ds };
              tx.set(ref, { links:arr, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
            });
            await openBrand(brandId);
          });

          const btnDel = document.createElement("button");
          btnDel.className = "btn danger";
          btnDel.textContent = "Delete";
          btnDel.addEventListener("click", async (e) => {
            e.stopPropagation();
            if (!confirm("Delete this link?")) return;

            await db.runTransaction(async (tx) => {
              const s = await tx.get(ref);
              const dd = s.exists ? s.data() : {};
              const arr = Array.isArray(dd.links) ? dd.links : [];
              arr.splice(idx, 1);
              tx.set(ref, { links:arr, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
            });
            await openBrand(brandId);
          });

          actions.appendChild(btnEdit);
          actions.appendChild(btnDel);
          el.appendChild(actions);
        }

        container.appendChild(el);
      });
    }

    $("btnBackToResources").addEventListener("click", () => {
      $("resourceDetail").style.display = "none";
      $("resourcesList").style.display = "flex";
      activeBrandId = null;
    });

    $("btnAddCategory").addEventListener("click", async () => {
      if (!canEditContent()) return alert("Not allowed.");
      const name = prompt("Category name");
      if (!name) return;
      const description = prompt("Description (optional)") || "";
      const id = slugifyName(name);

      await db.collection("brands").doc(id).set({
        name, description, links: [],
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge:true });

      await loadBrands();
    });

    $("btnDeleteCategory").addEventListener("click", async () => {
      if (!isAdmin()) return alert("Only admin can delete categories.");
      if (!activeBrandId) return alert("Open a category first.");
      if (!confirm("Delete this category doc?")) return;
      await db.collection("brands").doc(activeBrandId).delete();
      activeBrandId = null;
      await loadBrands();
      $("resourceDetail").style.display = "none";
      $("resourcesList").style.display = "flex";
    });

    $("btnAddLink").addEventListener("click", async () => {
      if (!canEditContent()) return alert("Not allowed.");
      if (!activeBrandId) return alert("Open a category first.");

      const title = prompt("Link title"); if (!title) return;
      const url = prompt("URL (include https://)"); if (!url) return;
      const desc = prompt("Description (optional)") || "";

      const ref = db.collection("brands").doc(activeBrandId);
      await db.runTransaction(async (tx) => {
        const s = await tx.get(ref);
        const d = s.exists ? s.data() : {};
        const links = Array.isArray(d.links) ? d.links : [];
        links.push({ title, url, desc });
        tx.set(ref, { links, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
      });

      await openBrand(activeBrandId);
    });

    async function loadUtilities(){
      const list = $("utilitiesList");
      list.innerHTML = "";
      const snap = await db.collection("utilities").orderBy("name").get();
      if (snap.empty){ list.innerHTML = `<div class="muted small">No utilities yet.</div>`; return; }
      snap.forEach(doc => {
        const d = doc.data();
        const el = document.createElement("div");
        el.className = "item clickable";
        el.innerHTML = `<div class="title">${escapeHtml(d.name || doc.id)}</div><div class="desc">${escapeHtml(d.desc || d.url || "")}</div>`;
        el.addEventListener("click", async () => {
          await trackClick(`utility:${doc.id}`, { title: d.name || doc.id, url: d.url || "" });
          if (d.url) window.open(d.url, "_blank", "noopener,noreferrer");
        });

        if (canEditContent()){
          const actions = document.createElement("div");
          actions.className = "actions";

          const btnEdit = document.createElement("button");
          btnEdit.className = "btn";
          btnEdit.textContent = "Edit";
          btnEdit.addEventListener("click", async (e) => {
            e.stopPropagation();
            const name = prompt("Edit name", d.name || ""); if (name === null) return;
            const url = prompt("Edit URL", d.url || ""); if (url === null) return;
            const desc = prompt("Edit description", d.desc || ""); if (desc === null) return;
            await db.collection("utilities").doc(doc.id).set({ name, url, desc, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
            await loadUtilities();
          });

          const btnDel = document.createElement("button");
          btnDel.className = "btn danger";
          btnDel.textContent = "Delete";
          btnDel.addEventListener("click", async (e) => {
            e.stopPropagation();
            if (!confirm("Delete this utility?")) return;
            await db.collection("utilities").doc(doc.id).delete();
            await loadUtilities();
          });

          actions.appendChild(btnEdit);
          actions.appendChild(btnDel);
          el.appendChild(actions);
        }

        list.appendChild(el);
      });
    }

    $("btnAddUtility").addEventListener("click", async () => {
      if (!canEditContent()) return alert("Not allowed.");
      const name = prompt("Utility name"); if (!name) return;
      const url = prompt("URL (include https://)"); if (!url) return;
      const desc = prompt("Description (optional)") || "";
      const id = slugifyName(name);
      await db.collection("utilities").doc(id).set({
        name, url, desc,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge:true });
      await loadUtilities();
    });

    async function loadEvents(){
      const list = $("eventsList");
      list.innerHTML = "";
      const snap = await db.collection("events").orderBy("date").limit(100).get();
      if (snap.empty){ list.innerHTML = `<div class="muted small">No events yet.</div>`; return; }
      snap.forEach(doc => {
        const d = doc.data();
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `<div class="title">${escapeHtml(d.title || "Event")}</div><div class="desc">${escapeHtml((d.date || "") + (d.location ? (" • " + d.location) : ""))}</div>`;

        if (canEditContent()){
          const actions = document.createElement("div");
          actions.className = "actions";

          const btnEdit = document.createElement("button");
          btnEdit.className = "btn";
          btnEdit.textContent = "Edit";
          btnEdit.addEventListener("click", async () => {
            const title = prompt("Edit title", d.title || ""); if (title === null) return;
            const date = prompt("Edit date (YYYY-MM-DD)", d.date || ""); if (date === null) return;
            const location = prompt("Edit location", d.location || ""); if (location === null) return;
            await db.collection("events").doc(doc.id).set({ title, date, location, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
            await loadEvents();
          });

          const btnDel = document.createElement("button");
          btnDel.className = "btn danger";
          btnDel.textContent = "Delete";
          btnDel.addEventListener("click", async () => {
            if (!confirm("Delete this event?")) return;
            await db.collection("events").doc(doc.id).delete();
            await loadEvents();
          });

          actions.appendChild(btnEdit);
          actions.appendChild(btnDel);
          el.appendChild(actions);
        }

        list.appendChild(el);
      });
    }

    $("btnAddEvent").addEventListener("click", async () => {
      if (!canEditContent()) return alert("Not allowed.");
      const title = prompt("Event title"); if (!title) return;
      const date = prompt("Date (YYYY-MM-DD)"); if (!date) return;
      const location = prompt("Location (optional)") || "";
      const id = "evt-" + Date.now();
      await db.collection("events").doc(id).set({
        title, date, location,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge:true });
      await loadEvents();
    });

    async function trackClick(key, meta){
      if (!currentUser) return;
      await db.collection("stats").doc(key).set({
        key,
        count: firebase.firestore.FieldValue.increment(1),
        lastClickedAt: firebase.firestore.FieldValue.serverTimestamp(),
        lastMeta: meta || {}
      }, { merge:true });
    }
    async function loadTopStats(limit=10){
      const list = $("statsList");
      list.innerHTML = "";
      const snap = await db.collection("stats").orderBy("count","desc").limit(limit).get();
      if (snap.empty){ list.innerHTML = `<div class="muted small">No stats yet.</div>`; return; }
      snap.forEach(doc => {
        const d = doc.data();
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `<div class="title">${escapeHtml(d.lastMeta?.title || d.key || doc.id)} <span class="pill">${escapeHtml(d.count || 0)}</span></div><div class="desc">${escapeHtml(d.lastMeta?.url || "")}</div>`;
        list.appendChild(el);
      });
    }
    async function loadOverview(){
      try{
        const usersSnap = await db.collection("users").limit(500).get();
        $("ovUsers").textContent = usersSnap.size;

        const top = await db.collection("stats").orderBy("count","desc").limit(1).get();
        if (!top.empty){
          const d = top.docs[0].data();
          $("ovTopLink").textContent = (d.lastMeta?.title || d.lastMeta?.url || d.key || "—") + " (" + (d.count||0) + ")";
        } else {
          $("ovTopLink").textContent = "—";
        }
        const mod = await db.collection("modActions").orderBy("ts","desc").limit(200).get();
        $("ovModActions").textContent = mod.size;
      }catch(e){}
    }

    function renderMessage(container, data){
      const el = document.createElement("div");
      el.className = "msg";
      el.innerHTML = `<div class="meta"><span>${escapeHtml(data.alias || data.email || data.uid || "user")}</span><span>${escapeHtml(fmtTime(data.ts))}</span></div><div class="text">${escapeHtml(data.text || "")}</div>`;
      container.appendChild(el);
    }
    function listenChat(collectionName, boxId, setUnsub){
      const box = $(boxId);
      box.innerHTML = "";
      const unsub = db.collection(collectionName).orderBy("ts","desc").limit(120).onSnapshot((snap) => {
        box.innerHTML = "";
        snap.docs.slice().reverse().forEach(d => renderMessage(box, d.data()));
        box.scrollTop = box.scrollHeight;
      });
      setUnsub(unsub);
    }
    function updateChatNotices(){
      const chatSuspended = isActiveUntil(currentUserDoc?.chatSuspendedUntil);
      const untilStr = chatSuspended ? currentUserDoc.chatSuspendedUntil.toDate().toLocaleString() : "";
      $("memberChatNotice").textContent = chatSuspended ? ("Chat suspended until: " + untilStr) : "";
      $("staffChatNotice").textContent = chatSuspended ? ("Chat suspended until: " + untilStr) : "";
      $("btnSendMember").disabled = chatSuspended;
      $("btnSendStaff").disabled = chatSuspended;
      $("memberChatInput").disabled = chatSuspended;
      $("staffChatInput").disabled = chatSuspended;
    }
    async function sendChat(collectionName, inputId){
      if (isActiveUntil(currentUserDoc?.chatSuspendedUntil)) return;
      const input = $(inputId);
      const text = (input.value || "").trim();
      if (!text) return;
      input.value = "";
      await db.collection(collectionName).add({
        uid: currentUser.uid,
        email: currentUser.email || "",
        alias: currentUserDoc?.alias || (currentUser.email || "user").split("@")[0],
        text,
        ts: firebase.firestore.FieldValue.serverTimestamp()
      });
    }
    $("btnSendMember").addEventListener("click", () => sendChat("memberChat","memberChatInput"));
    $("memberChatInput").addEventListener("keydown", (e) => { if (e.key === "Enter") sendChat("memberChat","memberChatInput"); });
    $("btnSendStaff").addEventListener("click", () => sendChat("staffChat","staffChatInput"));
    $("staffChatInput").addEventListener("keydown", (e) => { if (e.key === "Enter") sendChat("staffChat","staffChatInput"); });

    async function logModAction(action){
      await db.collection("modActions").add(Object.assign({}, action, { ts: firebase.firestore.FieldValue.serverTimestamp() }));
    }

    function userCardTitle(d, uid){
      const role = normRole(d.role);
      const tags = [];
      if (uid === OWNER_UID) tags.push("OWNER");
      if (d.banned) tags.push("BANNED");
      if (isActiveUntil(d.disabledUntil)) tags.push("SITE SUSP");
      if (isActiveUntil(d.chatSuspendedUntil)) tags.push("CHAT SUSP");
      if ((d.warnings||0) > 0) tags.push("WARN:" + (d.warnings||0));
      return `${escapeHtml(d.alias || d.email || uid)} <span class="pill">${escapeHtml(role)}</span> <span class="muted small">${escapeHtml(tags.join(" • "))}</span>`;
    }

    async function loadUsersForAdmin(){
      const list = $("usersList");
      list.innerHTML = "";
      const actorUid = currentUser?.uid;
      const actorRole = normRole(currentUserDoc?.role);

      const snap = await db.collection("users").orderBy("email").limit(500).get();
      if (snap.empty){ list.innerHTML = `<div class="muted small">No user docs.</div>`; return; }

      snap.forEach(doc => {
        const uid = doc.id;
        const d = doc.data() || {};
        const targetRole = normRole(d.role);

        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `<div class="title">${userCardTitle(d, uid)}</div><div class="desc">${escapeHtml(d.email || "")} • warnings: <b>${escapeHtml(d.warnings || 0)}</b></div>`;

        const actions = document.createElement("div");
        actions.className = "actions";

        const allowed = canModerateTarget(actorUid, actorRole, uid, targetRole);

        const btnWarn = document.createElement("button");
        btnWarn.className = "btn";
        btnWarn.textContent = "Warn";
        btnWarn.disabled = !allowed;
        btnWarn.addEventListener("click", async () => {
          if (!allowed) return;
          await db.collection("users").doc(uid).set({ warnings: firebase.firestore.FieldValue.increment(1), updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
          await logModAction({ actorUid, actorRole, targetUid: uid, targetRole, type:"warn", details:{} });
          await refreshAdminStuff();
        });
        actions.appendChild(btnWarn);

        const btnChat = document.createElement("button");
        btnChat.className = "btn danger";
        btnChat.textContent = "Suspend Chat";
        btnChat.disabled = !allowed;
        btnChat.addEventListener("click", async () => {
          if (!allowed) return;
          const maxDays = maxSuspendDays(actorRole);
          const days = Number(prompt(`Suspend chat days (1-${maxDays})`, "7"));
          if (!Number.isFinite(days) || days < 1 || days > maxDays) return alert("Invalid days.");
          await db.collection("users").doc(uid).set({ chatSuspendedUntil: addDays(days), updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
          await logModAction({ actorUid, actorRole, targetUid: uid, targetRole, type:"suspend_chat", details:{ days } });
          await refreshAdminStuff();
        });
        actions.appendChild(btnChat);

        const btnSite = document.createElement("button");
        btnSite.className = "btn danger";
        btnSite.textContent = "Suspend Site";
        btnSite.disabled = !allowed;
        btnSite.addEventListener("click", async () => {
          if (!allowed) return;
          const maxDays = maxSuspendDays(actorRole);
          const days = Number(prompt(`Suspend site days (1-${maxDays})`, "7"));
          if (!Number.isFinite(days) || days < 1 || days > maxDays) return alert("Invalid days.");
          await db.collection("users").doc(uid).set({ disabledUntil: addDays(days), updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
          await logModAction({ actorUid, actorRole, targetUid: uid, targetRole, type:"suspend_site", details:{ days } });
          await refreshAdminStuff();
        });
        actions.appendChild(btnSite);

        const btnClear = document.createElement("button");
        btnClear.className = "btn";
        btnClear.textContent = "Clear Suspensions";
        btnClear.disabled = !allowed;
        btnClear.addEventListener("click", async () => {
          if (!allowed) return;
          await db.collection("users").doc(uid).set({ chatSuspendedUntil: null, disabledUntil: null, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
          await logModAction({ actorUid, actorRole, targetUid: uid, targetRole, type:"clear_suspensions", details:{} });
          await refreshAdminStuff();
        });
        actions.appendChild(btnClear);

        const btnBan = document.createElement("button");
        btnBan.className = "btn danger";
        btnBan.textContent = d.banned ? "Unban" : "Ban";
        btnBan.disabled = !(canBan(actorRole) && allowed);
        btnBan.addEventListener("click", async () => {
          if (!(canBan(actorRole) && allowed)) return;
          if (!confirm(d.banned ? "Unban this user?" : "Ban this user?")) return;
          await db.collection("users").doc(uid).set({ banned: !d.banned, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
          await logModAction({ actorUid, actorRole, targetUid: uid, targetRole, type: d.banned ? "unban":"ban", details:{} });
          await refreshAdminStuff();
        });
        actions.appendChild(btnBan);

        const btnRole = document.createElement("button");
        btnRole.className = "btn";
        btnRole.textContent = "Change Role";
        btnRole.disabled = !(canChangeRole(actorRole) && allowed);
        btnRole.addEventListener("click", async () => {
          if (!(canChangeRole(actorRole) && allowed)) return;
          const newRole = prompt("Set role: member, contributor, manager, co-admin, admin", targetRole);
          if (!newRole) return;
          const nr = normRole(newRole);
          if (!["member","contributor","manager","co-admin","admin"].includes(nr)) return alert("Invalid role.");
          if (nr === "admin" && actorUid !== OWNER_UID) return alert("Only the OWNER can create admins.");
          await db.collection("users").doc(uid).set({ role: nr, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
          await logModAction({ actorUid, actorRole, targetUid: uid, targetRole, type:"change_role", details:{ to:nr } });
          await refreshAdminStuff();
        });
        actions.appendChild(btnRole);

        el.appendChild(actions);
        list.appendChild(el);
      });
    }

    async function loadModLogs(){
      const list = $("modLogs");
      list.innerHTML = "";
      const snap = await db.collection("modActions").orderBy("ts","desc").limit(80).get();
      if (snap.empty){ list.innerHTML = `<div class="muted small">No mod actions yet.</div>`; return; }
      snap.forEach(doc => {
        const d = doc.data() || {};
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `<div class="title">${escapeHtml(d.type || "action")} <span class="pill">${escapeHtml(d.actorRole || "")}</span></div><div class="desc">actor: ${escapeHtml(d.actorUid || "")} • target: ${escapeHtml(d.targetUid || "")} • ${escapeHtml(fmtTime(d.ts))}</div>`;
        list.appendChild(el);
      });
    }

    async function refreshAdminStuff(){
      await loadOverview();
      await loadTopStats(10);
      await loadUsersForAdmin();
      await loadModLogs();
    }

    $("btnAdminRefresh").addEventListener("click", refreshAdminStuff);
    $("btnHardReload").addEventListener("click", () => window.location.reload(true));

    if (systemPrefersDark()) document.documentElement.setAttribute("data-theme","dark");

    auth.onAuthStateChanged(async (user) => {
      clearAll();
      if (unsubMemberChat) { unsubMemberChat(); unsubMemberChat = null; }
      if (unsubStaffChat) { unsubStaffChat(); unsubStaffChat = null; }
      if (unsubSelfDoc) { unsubSelfDoc(); unsubSelfDoc = null; }

      if (!user){
        currentUser = null;
        currentUserDoc = null;
        setSignedInUI(false);
        roleBadge.textContent = "signed out";
        userAliasEl.textContent = "Guest";
        userEmailEl.textContent = "—";
        setView("homeView");
        return;
      }

      currentUser = user;
      const uref = await ensureUserDoc(user);
      const usnap = await uref.get();
      currentUserDoc = usnap.data() || {};

      if (!currentUserDoc.alias){
        await uref.set({ alias: (user.email || "user").split("@")[0] }, { merge:true });
        const s2 = await uref.get();
        currentUserDoc = s2.data() || currentUserDoc;
      }

      await applyAccountRestrictions();

      setSignedInUI(true);
      roleBadge.textContent = normRole(currentUserDoc.role);
      userAliasEl.textContent = currentUserDoc.alias || (user.email || "user").split("@")[0];
      userEmailEl.textContent = user.email || "";

      setTabsForRole();
      await loadSettings(user.uid);

      await loadBrands();
      await loadUtilities();
      await loadEvents();
      await loadOverview();

      listenChat("memberChat","memberChatBox",(u)=>unsubMemberChat=u);

      if (canUseStaffChat()){
        listenChat("staffChat","staffChatBox",(u)=>unsubStaffChat=u);
      } else {
        $("staffChatBox").innerHTML = `<div class="muted small">Not authorized.</div>`;
      }

      updateChatNotices();

      if (canUseAdmin()) await refreshAdminStuff();

      unsubSelfDoc = db.collection("users").doc(user.uid).onSnapshot(async (snap) => {
        if (!snap.exists) return;
        currentUserDoc = snap.data() || currentUserDoc;
        if (currentUserDoc.banned || isActiveUntil(currentUserDoc.disabledUntil)){
          await applyAccountRestrictions(); return;
        }
        setTabsForRole();
        updateChatNotices();
      });

      setView("homeView");
    });
  </script>
</body>
</html>
