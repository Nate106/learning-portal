<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Learning Portal</title>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    :root{
      --bg:#f6f7f9;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --accent:#2563eb;
      --nav:#ffffff;
      --shadow: 0 8px 25px rgba(17,24,39,.06);
      --radius:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    html[data-theme="dark"]{
      --bg:#0b1220;
      --card:#0f172a;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --border:#1f2a44;
      --accent:#60a5fa;
      --nav:#0f172a;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:var(--sans);background:var(--bg);color:var(--text)}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .topbar{position:sticky;top:0;z-index:30;background:var(--nav);border-bottom:1px solid var(--border);backdrop-filter:saturate(180%) blur(10px)}
    .nav{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 18px;max-width:1100px;margin:0 auto}
    .brand{display:flex;align-items:center;gap:10px;font-weight:750;letter-spacing:.2px}
    .badge{font-family:var(--mono);font-size:12px;padding:3px 8px;border:1px solid var(--border);border-radius:999px;color:var(--muted)}
    .navlinks{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .tab{border:1px solid var(--border);background:transparent;color:var(--text);padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:600;font-size:13px}
    .tab.active{background:rgba(37,99,235,.12);border-color:rgba(37,99,235,.35)}
    .tab:disabled{opacity:.45;cursor:not-allowed}
    .right{display:flex;align-items:center;gap:10px}
    .userpill{display:flex;align-items:center;gap:8px;border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:13px;color:var(--muted)}
    .pill{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:3px 8px;font-size:12px;color:var(--muted);margin-left:8px;font-family:var(--mono)}
    .btn{border:1px solid var(--border);background:var(--card);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:650}
    .btn.primary{border-color:rgba(37,99,235,.45);background:rgba(37,99,235,.12)}
    .btn.danger{border-color:rgba(239,68,68,.45);background:rgba(239,68,68,.10)}
    .grid{display:grid;grid-template-columns:320px 1fr;gap:14px;margin-top:14px}
    @media (max-width: 920px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
    .card h2,.card h3{margin:0 0 10px 0}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--text);outline:none}
    .row{display:flex;gap:10px}
    .row>*{flex:1}
    .divider{height:1px;background:var(--border);margin:12px 0}
    .views>section{display:none}
    .views>section.active{display:block}
    .list{display:flex;flex-direction:column;gap:8px}
    .item{border:1px solid var(--border);border-radius:12px;padding:10px 12px;background:transparent}
    .item.clickable{cursor:pointer}
    .item.clickable:hover{border-color:rgba(37,99,235,.35)}
    .item .title{font-weight:700}
    .item .desc{color:var(--muted);font-size:12px;margin-top:2px}
    .chatbox{height:340px;overflow:auto;border:1px solid var(--border);border-radius:12px;padding:10px;background:transparent}
    .msg{padding:8px 10px;border-radius:10px;border:1px solid var(--border);margin-bottom:8px}
    .msg .meta{font-size:12px;color:var(--muted);display:flex;justify-content:space-between;gap:10px}
    .msg .text{margin-top:6px;white-space:pre-wrap}
    footer{margin:22px 0 40px;text-align:center;color:var(--muted);font-size:12px}
    footer a{color:var(--muted)}
    .dangerText{color:#ef4444}
  </style>
</head>

<body>
  <div class="topbar" id="topbar" style="display:none;">
    <div class="nav">
      <div class="brand">
        <span>Learning Portal</span>
        <span class="badge" id="roleBadge">—</span>
      </div>

      <div class="navlinks">
        <button class="tab" data-view="homeView" id="tabHome">Home</button>
        <button class="tab" data-view="resourcesView" id="tabResources">Study Resources</button>
        <button class="tab" data-view="utilitiesView" id="tabUtilities">Utilities</button>
        <button class="tab" data-view="memberChatView" id="tabMemberChat">Member Chat</button>
        <button class="tab" data-view="staffChatView" id="tabStaffChat">Staff Chat</button>
        <button class="tab" data-view="calendarView" id="tabCalendar">Calendar</button>
        <button class="tab" data-view="adminView" id="tabAdmin">Admin</button>
        <button class="tab" data-view="settingsView" id="tabSettings">Settings</button>
      </div>

      <div class="right">
        <div class="userpill">
          <span id="userName">Guest</span>
          <span class="pill" id="userEmail">—</span>
        </div>
        <button class="btn" id="btnSignOut">Sign out</button>
      </div>
    </div>
  </div>

  <div class="wrap">

    <!-- LOGIN ONLY (nothing else shown until signed in) -->
    <div class="card" id="authCard">
      <h2>Sign in</h2>
      <p class="muted">Use the email/password account that an admin created for you.</p>
      <div class="row">
        <div>
          <label class="small muted">Email</label>
          <input class="input" id="email" type="email" placeholder="you@example.com" autocomplete="username" />
        </div>
        <div>
          <label class="small muted">Password</label>
          <input class="input" id="password" type="password" placeholder="••••••••" autocomplete="current-password" />
        </div>
      </div>
      <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;">
        <button class="btn primary" id="btnLogin">Sign in</button>
        <button class="btn" id="btnReset">Reset password</button>
      </div>
      <div class="divider"></div>
      <p class="small" id="authMsg"></p>
      <p class="small muted">
        <b>Admins:</b> create accounts in Firebase Console → Authentication → Users.
      </p>
    </div>

    <!-- APP -->
    <div class="grid" id="appGrid" style="display:none;">
      <div class="card">
        <h3>Overview</h3>
        <div class="list">
          <div class="item">
            <div class="title">Users</div>
            <div class="desc"><span id="ovUsers">—</span> total</div>
          </div>
          <div class="item">
            <div class="title">Top Link</div>
            <div class="desc" id="ovTopLink">—</div>
          </div>
          <div class="item">
            <div class="title">Mod Actions</div>
            <div class="desc"><span id="ovModActions">—</span> logged</div>
          </div>
        </div>
        <div class="divider"></div>
        <p class="small muted">Real security must be enforced with Firestore rules.</p>
      </div>

      <div class="views">

        <section id="homeView" class="card active">
          <h2>Home</h2>
          <p class="muted">Welcome. Use tabs to navigate.</p>
          <div class="divider"></div>
          <div class="card" style="box-shadow:none;">
            <h3>Quick info</h3>
            <ul class="muted">
              <li>Roles are stored in <span style="font-family:var(--mono)">users/{uid}.role</span></li>
              <li>Preferences are stored in <span style="font-family:var(--mono)">settings/{uid}</span></li>
              <li>Click stats aggregate into <span style="font-family:var(--mono)">stats/{key}</span></li>
            </ul>
          </div>
        </section>

        <section id="resourcesView" class="card">
          <h2>Study Resources</h2>
          <p class="muted">Pick a category to open its links.</p>
          <div class="divider"></div>
          <div id="resourcesList" class="list"></div>

          <div class="divider"></div>

          <div id="resourceDetail" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:10px; flex-wrap:wrap;">
              <div>
                <h3 id="resourceTitle" style="margin-bottom:4px;">Category</h3>
                <div class="muted small" id="resourceMeta"></div>
              </div>
              <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button class="btn" id="btnBackToResources">Back</button>
                <button class="btn primary" id="btnAddLink" style="display:none;">Add link</button>
              </div>
            </div>
            <div class="divider"></div>
            <div id="resourceLinks" class="list"></div>
          </div>
        </section>

        <section id="utilitiesView" class="card">
          <h2>Utilities</h2>
          <p class="muted">Standalone tools and links.</p>
          <div class="divider"></div>
          <div id="utilitiesList" class="list"></div>
          <div class="divider"></div>
          <button class="btn primary" id="btnAddUtility" style="display:none;">Add utility</button>
        </section>

        <section id="memberChatView" class="card">
          <h2>Member Chat</h2>
          <p class="muted">Real-time group messages.</p>
          <div class="divider"></div>
          <div class="chatbox" id="memberChatBox"></div>
          <div class="divider"></div>
          <div class="row">
            <input class="input" id="memberChatInput" placeholder="Message..." maxlength="600" />
            <button class="btn primary" id="btnSendMember">Send</button>
          </div>
          <p class="small muted" id="memberChatNotice"></p>
        </section>

        <section id="staffChatView" class="card">
          <h2>Staff Chat</h2>
          <p class="muted">Staff-only chat (contributors+).</p>
          <div class="divider"></div>
          <div class="chatbox" id="staffChatBox"></div>
          <div class="divider"></div>
          <div class="row">
            <input class="input" id="staffChatInput" placeholder="Staff message..." maxlength="600" />
            <button class="btn primary" id="btnSendStaff">Send</button>
          </div>
          <p class="small muted" id="staffChatNotice"></p>
        </section>

        <section id="calendarView" class="card">
          <h2>Calendar</h2>
          <p class="muted">Events from Firestore.</p>
          <div class="divider"></div>
          <div id="eventsList" class="list"></div>
          <div class="divider"></div>
          <button class="btn primary" id="btnAddEvent" style="display:none;">Add event</button>
        </section>

        <section id="adminView" class="card">
          <h2>Admin Panel</h2>
          <p class="muted">Moderation + content + stats.</p>
          <div class="divider"></div>

          <div id="adminLocked" class="card" style="box-shadow:none;">
            <h3>Not authorized</h3>
            <p class="muted">You don’t have permission to use admin tools.</p>
          </div>

          <div id="adminTools" style="display:none;">
            <h3>Top Stats</h3>
            <div id="statsList" class="list"></div>

            <div class="divider"></div>

            <h3>Users</h3>
            <p class="small muted">
              Roles come from <span style="font-family:var(--mono)">users/{uid}.role</span>.
              <br><b>Rule:</b> Only <b>admin</b> can moderate staff. Co-admin/manager can only moderate members.
            </p>
            <div id="usersList" class="list"></div>

            <div class="divider"></div>

            <h3>Mod Logs</h3>
            <div id="modLogs" class="list"></div>
          </div>
        </section>

        <section id="settingsView" class="card">
          <h2>Settings</h2>
          <p class="muted">Theme + safe redirect.</p>

          <div class="divider"></div>

          <h3>Theme</h3>
          <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
            <button class="btn" id="btnThemeAuto">Auto</button>
            <button class="btn" id="btnThemeLight">Light</button>
            <button class="btn" id="btnThemeDark">Dark</button>
            <span class="small muted" id="themeStatus"></span>
          </div>

          <div class="divider"></div>

          <h3>Safe redirect</h3>
          <p class="small muted">Optional: sign out then redirect.</p>
          <div class="row">
            <input class="input" id="safeRedirectUrl" placeholder="https://example.com" />
            <button class="btn danger" id="btnQuickLogout">Sign out & Redirect</button>
          </div>

          <div class="divider"></div>

          <h3>Info</h3>
          <ul class="small muted">
            <li><a href="#" onclick="alert('Placeholder: Updates'); return false;">Updates</a></li>
            <li><a href="#" onclick="alert('Placeholder: Announcements'); return false;">Announcements</a></li>
            <li><a href="#" onclick="alert('Placeholder: Terms'); return false;">Terms</a></li>
            <li><a href="#" onclick="alert('Placeholder: Privacy'); return false;">Privacy</a></li>
          </ul>
        </section>

      </div>
    </div>

    <footer id="footer" style="display:none;">
      <div>Learning Portal • Firebase free tier • client-side</div>
      <div class="small">
        <a href="#" onclick="alert('Placeholder: Terms'); return false;">Terms</a> •
        <a href="#" onclick="alert('Placeholder: Privacy'); return false;">Privacy</a> •
        <a href="#" onclick="alert('Placeholder: Updates'); return false;">Updates</a>
      </div>
    </footer>

  </div>

  <script>
    /***********************
     * Firebase config
     ***********************/
    const firebaseConfig = {
      apiKey: "AIzaSyCBj78TuU8hviaYMILXkXIzNtU8yIgk39c",
      authDomain: "learning-resources-2026.firebaseapp.com",
      projectId: "learning-resources-2026",
      storageBucket: "learning-resources-2026.firebasestorage.app",
      messagingSenderId: "67701812368",
      appId: "1:67701812368:web:d6ad7089316cdc66347c15",
      measurementId: "G-K867JHELDB"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    /***********************
     * Auth persistence: stays signed in across tabs/restarts
     ***********************/
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

    /***********************
     * Roles + rules
     ***********************/
    const ROLES = ["member","contributor","manager","co-admin","admin"];
    const ROLE_RANK = {"member":0,"contributor":1,"manager":2,"co-admin":3,"admin":4};
    const OWNER_UID = "BEz5gSlOjOhMJVbalAONPZspvus1"; // you

    function normRole(r){ return (r || "member").toLowerCase().trim(); }
    function rankOf(r){ return ROLE_RANK[normRole(r)] ?? 0; }
    function isStaffRole(r){ return rankOf(r) >= rankOf("contributor"); }

    // Only ADMIN can moderate staff.
    // co-admin + manager can moderate members only.
    // contributor can't moderate.
    function canModerateTarget(actorRole, targetRole){
      actorRole = normRole(actorRole);
      targetRole = normRole(targetRole);

      if (actorRole === "contributor") return false;

      const a = rankOf(actorRole);
      const t = rankOf(targetRole);

      // Nobody touches owner
      if (targetRole === "admin" && currentUser?.uid !== OWNER_UID && targetUidTemp === OWNER_UID) return false;

      // Nobody can moderate equal or higher
      if (t >= a) return false;

      // If target is staff, ONLY admin can act
      if (isStaffRole(targetRole)) return actorRole === "admin";

      // target is member
      return ["admin","co-admin","manager"].includes(actorRole);
    }

    function isAdminOnly(){ return normRole(currentUserDoc?.role) === "admin"; }
    function canChangeRole(actorRole){ return normRole(actorRole) === "admin"; }
    function canBan(actorRole){ return normRole(actorRole) === "admin"; }

    // Temp var used inside canModerateTarget owner check
    let targetUidTemp = null;

    /***********************
     * UI helpers
     ***********************/
    const $ = (id) => document.getElementById(id);

    const authCard = $("authCard");
    const appGrid = $("appGrid");
    const topbar = $("topbar");
    const footer = $("footer");
    const authMsg = $("authMsg");

    const tabs = Array.from(document.querySelectorAll(".tab"));
    const sections = Array.from(document.querySelectorAll(".views > section"));

    function setAuthMessage(msg, isError=false){
      authMsg.textContent = msg || "";
      authMsg.className = "small " + (isError ? "dangerText" : "");
    }

    function setView(viewId){
      sections.forEach(s => s.classList.toggle("active", s.id === viewId));
      tabs.forEach(t => t.classList.toggle("active", t.dataset.view === viewId));
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    tabs.forEach(t => t.addEventListener("click", () => {
      if (t.disabled) return;
      setView(t.dataset.view);
    }));

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    /***********************
     * Theme + settings
     ***********************/
    const themeStatus = $("themeStatus");
    const safeRedirectUrl = $("safeRedirectUrl");

    let currentThemeMode = "auto";
    function systemPrefersDark(){
      return window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
    }
    function applyTheme(mode){
      currentThemeMode = mode;
      if (mode === "auto"){
        document.documentElement.removeAttribute("data-theme");
        if (systemPrefersDark()) document.documentElement.setAttribute("data-theme","dark");
        themeStatus.textContent = "Following system";
      } else {
        document.documentElement.setAttribute("data-theme", mode);
        themeStatus.textContent = "Theme: " + mode;
      }
    }

    if (window.matchMedia){
      window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", () => {
        if (currentThemeMode === "auto") applyTheme("auto");
      });
    }

    async function loadSettings(uid){
      const ref = db.collection("settings").doc(uid);
      const snap = await ref.get();
      const s = snap.exists ? snap.data() : {};
      applyTheme(s.theme || "auto");
      safeRedirectUrl.value = s.safeRedirectUrl || "";
    }

    async function saveSettings(partial){
      if (!currentUser) return;
      const ref = db.collection("settings").doc(currentUser.uid);
      const payload = Object.assign({}, partial, {
        safeRedirectUrl: (safeRedirectUrl.value || "").trim(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      await ref.set(payload, { merge:true });

      if (partial.theme) applyTheme(partial.theme);
    }

    $("btnThemeAuto").addEventListener("click", () => saveSettings({ theme:"auto" }));
    $("btnThemeLight").addEventListener("click", () => saveSettings({ theme:"light" }));
    $("btnThemeDark").addEventListener("click", () => saveSettings({ theme:"dark" }));

    $("btnQuickLogout").addEventListener("click", async () => {
      const url = (safeRedirectUrl.value || "").trim();
      try{ await auth.signOut(); }catch(e){}
      if (url) window.location.href = url;
    });

    /***********************
     * Auth: login + reset only (no register)
     ***********************/
    $("btnLogin").addEventListener("click", async () => {
      const email = $("email").value.trim();
      const password = $("password").value;
      if (!email || !password) return setAuthMessage("Enter email and password.", true);

      setAuthMessage("Signing in...");
      try{
        await auth.signInWithEmailAndPassword(email, password);
        setAuthMessage("");
      }catch(e){
        setAuthMessage(e.message || "Sign in failed.", true);
      }
    });

    $("btnReset").addEventListener("click", async () => {
      const email = $("email").value.trim();
      if (!email) return setAuthMessage("Enter your email first.", true);
      setAuthMessage("Sending reset email...");
      try{
        await auth.sendPasswordResetEmail(email);
        setAuthMessage("Reset email sent.");
      }catch(e){
        setAuthMessage(e.message || "Reset failed.", true);
      }
    });

    $("btnSignOut").addEventListener("click", () => auth.signOut());

    /***********************
     * Current user state
     ***********************/
    let currentUser = null;
    let currentUserDoc = null;

    function setTabsEnabled(signedIn){
      ["tabHome","tabResources","tabUtilities","tabMemberChat","tabCalendar","tabSettings","tabStaffChat","tabAdmin"]
        .forEach(id => $(id).disabled = !signedIn);
    }

    function applyPermissions(){
      const role = normRole(currentUserDoc?.role);

      $("roleBadge").textContent = role;

      // staff chat: contributor+
      const staffChatOk = rankOf(role) >= rankOf("contributor");
      $("tabStaffChat").disabled = !staffChatOk;

      // admin panel: admin/co-admin/manager can view, but actions are restricted inside
      const adminPanelOk = ["admin","co-admin","manager"].includes(role);
      $("tabAdmin").disabled = !adminPanelOk;

      // Content editing (optional): contributor+
      const canEditContent = rankOf(role) >= rankOf("contributor");
      $("btnAddLink").style.display = canEditContent ? "inline-block" : "none";
      $("btnAddUtility").style.display = canEditContent ? "inline-block" : "none";
      $("btnAddEvent").style.display = canEditContent ? "inline-block" : "none";

      // Admin tools section
      $("adminLocked").style.display = adminPanelOk ? "none" : "block";
      $("adminTools").style.display = adminPanelOk ? "block" : "none";
    }

    /***********************
     * Ensure user doc exists (but DO NOT auto-assign staff roles)
     ***********************/
    async function ensureUserDoc(user){
      const ref = db.collection("users").doc(user.uid);
      const snap = await ref.get();
      if (!snap.exists){
        await ref.set({
          email: user.email || "",
          alias: (user.email || "user").split("@")[0],
          role: "member",
          disabled: false,
          banned: false,
          warnings: 0,
          chatSuspendedUntil: null,
          disabledUntil: null,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });
      }
      return ref;
    }

    /***********************
     * Enforcement: disabled/banned/suspensions
     ***********************/
    function nowMs(){ return Date.now(); }

    function tsToMs(ts){
      try{ return ts?.toDate ? ts.toDate().getTime() : null; }catch{ return null; }
    }

    function isActiveSuspension(ts){
      const ms = tsToMs(ts);
      return ms && ms > nowMs();
    }

    /***********************
     * Data loaders
     ***********************/
    let activeBrandId = null;

    async function loadOverview(){
      try{
        const usersSnap = await db.collection("users").limit(500).get();
        $("ovUsers").textContent = usersSnap.size;

        const top = await db.collection("stats").orderBy("count","desc").limit(1).get();
        if (!top.empty){
          const d = top.docs[0].data();
          $("ovTopLink").textContent = (d.lastMeta?.title || d.lastMeta?.url || d.key || "—") + " (" + (d.count||0) + ")";
        } else {
          $("ovTopLink").textContent = "—";
        }

        const mod = await db.collection("modActions").orderBy("ts","desc").limit(50).get();
        $("ovModActions").textContent = mod.size;
      }catch(e){
        // ignore overview failures
      }
    }

    async function loadBrands(){
      const list = $("resourcesList");
      list.innerHTML = "";
      $("resourceDetail").style.display = "none";
      $("resourcesList").style.display = "flex";

      const snap = await db.collection("brands").orderBy("name").get();
      if (snap.empty){
        list.innerHTML = `<div class="muted small">No categories yet.</div>`;
        return;
      }

      snap.forEach(doc => {
        const d = doc.data();
        const el = document.createElement("div");
        el.className = "item clickable";
        el.innerHTML = `
          <div class="title">${escapeHtml(d.name || doc.id)}</div>
          <div class="desc">${escapeHtml(d.description || "Open to view links")}</div>
        `;
        el.addEventListener("click", () => openBrand(doc.id));
        list.appendChild(el);
      });
    }

    async function openBrand(brandId){
      activeBrandId = brandId;

      const ref = db.collection("brands").doc(brandId);
      const snap = await ref.get();
      const d = snap.exists ? snap.data() : {};

      $("resourceTitle").textContent = d.name || brandId;
      $("resourceMeta").textContent = d.description || "";

      $("resourceDetail").style.display = "block";
      $("resourcesList").style.display = "none";

      const links = Array.isArray(d.links) ? d.links : [];
      const container = $("resourceLinks");
      container.innerHTML = "";

      if (!links.length){
        container.innerHTML = `<div class="muted small">No links here yet.</div>`;
        return;
      }

      links.forEach((link, idx) => {
        const title = link.title || ("Link " + (idx+1));
        const url = link.url || "";
        const desc = link.desc || "";

        const el = document.createElement("div");
        el.className = "item clickable";
        el.innerHTML = `
          <div class="title">${escapeHtml(title)}</div>
          <div class="desc">${escapeHtml(desc || url)}</div>
        `;
        el.addEventListener("click", async () => {
          await trackClick(`brand:${brandId}:${idx}`, { brandId, title, url });
          if (url) window.open(url, "_blank", "noopener,noreferrer");
        });

        container.appendChild(el);
      });
    }

    $("btnBackToResources").addEventListener("click", () => {
      $("resourceDetail").style.display = "none";
      $("resourcesList").style.display = "flex";
      activeBrandId = null;
    });

    async function loadUtilities(){
      const list = $("utilitiesList");
      list.innerHTML = "";
      const snap = await db.collection("utilities").orderBy("name").get();
      if (snap.empty){
        list.innerHTML = `<div class="muted small">No utilities yet.</div>`;
        return;
      }
      snap.forEach(doc => {
        const d = doc.data();
        const el = document.createElement("div");
        el.className = "item clickable";
        el.innerHTML = `
          <div class="title">${escapeHtml(d.name || doc.id)}</div>
          <div class="desc">${escapeHtml(d.desc || d.url || "")}</div>
        `;
        el.addEventListener("click", async () => {
          await trackClick(`utility:${doc.id}`, { title: d.name || doc.id, url: d.url || "" });
          if (d.url) window.open(d.url, "_blank", "noopener,noreferrer");
        });
        list.appendChild(el);
      });
    }

    async function loadEvents(){
      const list = $("eventsList");
      list.innerHTML = "";
      const snap = await db.collection("events").orderBy("date").limit(100).get();
      if (snap.empty){
        list.innerHTML = `<div class="muted small">No events yet.</div>`;
        return;
      }
      snap.forEach(doc => {
        const d = doc.data();
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="title">${escapeHtml(d.title || "Event")}</div>
          <div class="desc">${escapeHtml((d.date || "") + (d.location ? (" • " + d.location) : ""))}</div>
        `;
        list.appendChild(el);
      });
    }

    /***********************
     * Click stats (aggregated)
     ***********************/
    async function trackClick(key, meta){
      if (!currentUser) return;
      const ref = db.collection("stats").doc(key);
      await ref.set({
        key,
        count: firebase.firestore.FieldValue.increment(1),
        lastClickedAt: firebase.firestore.FieldValue.serverTimestamp(),
        lastMeta: meta || {}
      }, { merge:true });
    }

    async function loadTopStats(limit=10){
      const list = $("statsList");
      list.innerHTML = "";
      const snap = await db.collection("stats").orderBy("count","desc").limit(limit).get();
      if (snap.empty){
        list.innerHTML = `<div class="muted small">No stats yet.</div>`;
        return;
      }
      snap.forEach(doc => {
        const d = doc.data();
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="title">${escapeHtml(d.lastMeta?.title || d.key || doc.id)} <span class="pill">${escapeHtml(d.count || 0)}</span></div>
          <div class="desc">${escapeHtml(d.lastMeta?.url || "")}</div>
        `;
        list.appendChild(el);
      });
    }

    /***********************
     * Chat
     ***********************/
    let unsubMemberChat = null;
    let unsubStaffChat = null;

    function fmtTime(ts){
      try{
        const d = ts?.toDate ? ts.toDate() : null;
        return d ? d.toLocaleString() : "";
      }catch{ return ""; }
    }

    function renderMessage(container, data){
      const el = document.createElement("div");
      el.className = "msg";
      el.innerHTML = `
        <div class="meta">
          <span>${escapeHtml(data.alias || data.email || data.uid || "user")}</span>
          <span>${escapeHtml(fmtTime(data.ts))}</span>
        </div>
        <div class="text">${escapeHtml(data.text || "")}</div>
      `;
      container.appendChild(el);
    }

    function listenMemberChat(){
      if (unsubMemberChat) unsubMemberChat();
      const box = $("memberChatBox");
      box.innerHTML = "";
      unsubMemberChat = db.collection("memberChat")
        .orderBy("ts","desc").limit(100)
        .onSnapshot((snap) => {
          box.innerHTML = "";
          snap.docs.slice().reverse().forEach(d => renderMessage(box, d.data()));
          box.scrollTop = box.scrollHeight;
        });
    }

    function listenStaffChat(){
      if (unsubStaffChat) unsubStaffChat();
      const box = $("staffChatBox");
      box.innerHTML = "";
      unsubStaffChat = db.collection("staffChat")
        .orderBy("ts","desc").limit(100)
        .onSnapshot((snap) => {
          box.innerHTML = "";
          snap.docs.slice().reverse().forEach(d => renderMessage(box, d.data()));
          box.scrollTop = box.scrollHeight;
        });
    }

    async function sendChat(collectionName, inputId){
      const input = $(inputId);
      const text = (input.value || "").trim();
      if (!text) return;
      input.value = "";

      const alias = currentUserDoc?.alias || (currentUser.email || "user").split("@")[0];

      await db.collection(collectionName).add({
        uid: currentUser.uid,
        email: currentUser.email || "",
        alias,
        text,
        ts: firebase.firestore.FieldValue.serverTimestamp()
      });
    }

    $("btnSendMember").addEventListener("click", () => sendChat("memberChat","memberChatInput"));
    $("memberChatInput").addEventListener("keydown", (e) => { if (e.key === "Enter") sendChat("memberChat","memberChatInput"); });

    $("btnSendStaff").addEventListener("click", () => sendChat("staffChat","staffChatInput"));
    $("staffChatInput").addEventListener("keydown", (e) => { if (e.key === "Enter") sendChat("staffChat","staffChatInput"); });

    /***********************
     * Moderation + logs
     * stored in users/{uid} fields:
     * - warnings (number)
     * - chatSuspendedUntil (timestamp)
     * - disabledUntil (timestamp)
     * - banned (boolean)
     ***********************/
    async function logModAction(targetUid, action, details){
      try{
        await db.collection("modActions").add({
          actorUid: currentUser.uid,
          actorRole: normRole(currentUserDoc?.role),
          actorEmail: currentUser.email || "",
          targetUid,
          action,
          details: details || "",
          ts: firebase.firestore.FieldValue.serverTimestamp()
        });
      }catch(e){}
    }

    async function warnUser(targetUid, targetAlias){
      const actorRole = normRole(currentUserDoc?.role);
      const targetSnap = await db.collection("users").doc(targetUid).get();
      const targetRole = normRole(targetSnap.data()?.role);
      targetUidTemp = targetUid;

      if (!canModerateTarget(actorRole, targetRole)) return alert("Not allowed.");

      await db.collection("users").doc(targetUid).set({
        warnings: firebase.firestore.FieldValue.increment(1),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge:true });

      await logModAction(targetUid, "warn", targetAlias || "");
    }

    async function toggleChatSuspend(targetUid, targetAlias){
      const actorRole = normRole(currentUserDoc?.role);
      const targetSnap = await db.collection("users").doc(targetUid).get();
      const target = targetSnap.data() || {};
      const targetRole = normRole(target.role);
      targetUidTemp = targetUid;

      if (!canModerateTarget(actorRole, targetRole)) return alert("Not allowed.");

      const currently = isActiveSuspension(target.chatSuspendedUntil);

      if (currently){
        await db.collection("users").doc(targetUid).set({
          chatSuspendedUntil: null,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });
        await logModAction(targetUid, "chat_resume", targetAlias || "");
      } else {
        // default 1 day chat suspend (admin can change it easily later)
        const hours = 24;
        const until = new Date(Date.now() + hours * 60 * 60 * 1000);
        await db.collection("users").doc(targetUid).set({
          chatSuspendedUntil: firebase.firestore.Timestamp.fromDate(until),
          chatSuspensions: firebase.firestore.FieldValue.increment(1),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });
        await logModAction(targetUid, "chat_suspend", `${hours}h`);
      }
    }

    async function toggleSiteSuspend(targetUid, targetAlias){
      const actorRole = normRole(currentUserDoc?.role);
      const targetSnap = await db.collection("users").doc(targetUid).get();
      const target = targetSnap.data() || {};
      const targetRole = normRole(target.role);
      targetUidTemp = targetUid;

      if (!canModerateTarget(actorRole, targetRole)) return alert("Not allowed.");

      const currently = isActiveSuspension(target.disabledUntil) || !!target.disabled;

      if (currently){
        // unsuspend
        await db.collection("users").doc(targetUid).set({
          disabled: false,
          disabledUntil: null,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });
        await logModAction(targetUid, "unsuspend_site", targetAlias || "");
      } else {
        // managers can only suspend up to 7 days
        let days = 7;
        if (actorRole === "admin") {
          const ask = prompt("Suspend how many days? (admin can choose)", "7");
          const n = parseInt(ask || "7", 10);
          if (Number.isFinite(n) && n > 0 && n <= 365) days = n;
        }

        if (actorRole === "manager") days = 7;
        if (actorRole === "co-admin") days = 7;

        const until = new Date(Date.now() + days * 24 * 60 * 60 * 1000);
        await db.collection("users").doc(targetUid).set({
          disabled: false,
          disabledUntil: firebase.firestore.Timestamp.fromDate(until),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });

        await logModAction(targetUid, "suspend_site", `${days}d`);
      }
    }

    async function toggleBanUser(targetUid, targetAlias){
      const actorRole = normRole(currentUserDoc?.role);
      if (!canBan(actorRole)) return alert("Only admin can ban.");

      const targetSnap = await db.collection("users").doc(targetUid).get();
      const targetRole = normRole(targetSnap.data()?.role);
      targetUidTemp = targetUid;

      // even admin can't ban owner
      if (targetUid === OWNER_UID) return alert("Owner cannot be banned.");

      // only admin can ban staff too (allowed)
      const currently = !!targetSnap.data()?.banned;

      await db.collection("users").doc(targetUid).set({
        banned: !currently,
        bans: firebase.firestore.FieldValue.increment(currently ? 0 : 1),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge:true });

      await logModAction(targetUid, currently ? "unban" : "ban", targetAlias || "");
    }

    async function changeUserRole(targetUid, targetAlias, currentRole){
      const actorRole = normRole(currentUserDoc?.role);
      if (!canChangeRole(actorRole)) return alert("Only admin can change roles.");

      if (targetUid === OWNER_UID) return alert("Owner role cannot be changed.");

      const newRole = prompt("Set role: member, contributor, manager, co-admin, admin", currentRole || "member");
      if (!newRole) return;
      if (!ROLES.includes(newRole)) return alert("Invalid role.");

      await db.collection("users").doc(targetUid).set({
        role: newRole,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge:true });

      await logModAction(targetUid, "change_role", `${currentRole} -> ${newRole}`);
    }

    async function loadModLogs(){
      const list = $("modLogs");
      list.innerHTML = "";
      const snap = await db.collection("modActions").orderBy("ts","desc").limit(50).get();
      if (snap.empty){
        list.innerHTML = `<div class="muted small">No mod actions logged yet.</div>`;
        return;
      }
      snap.forEach(doc => {
        const d = doc.data();
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="title">${escapeHtml(d.action || "action")} <span class="pill">${escapeHtml(d.actorRole || "")}</span></div>
          <div class="desc">
            target: ${escapeHtml(d.targetUid || "")}
            • by: ${escapeHtml(d.actorEmail || "")}
            • ${escapeHtml(fmtTime(d.ts))}
            ${d.details ? " • " + escapeHtml(d.details) : ""}
          </div>
        `;
        list.appendChild(el);
      });
    }

    /***********************
     * Admin user list (buttons obey rules)
     ***********************/
    async function loadUsersForAdmin(){
      const list = $("usersList");
      list.innerHTML = "";

      const actorRole = normRole(currentUserDoc?.role);

      const snap = await db.collection("users").orderBy("email").limit(300).get();
      if (snap.empty){
        list.innerHTML = `<div class="muted small">No user docs yet.</div>`;
        return;
      }

      // overview counts
      $("ovUsers").textContent = snap.size;

      snap.forEach(doc => {
        const d = doc.data();
        const targetUid = doc.id;
        const targetRole = normRole(d.role);
        const alias = d.alias || d.email || targetUid;

        const disabledNow = !!d.disabled || isActiveSuspension(d.disabledUntil);
        const chatSuspNow = isActiveSuspension(d.chatSuspendedUntil);
        const banned = !!d.banned;

        const el = document.createElement("div");
        el.className = "item";

        el.innerHTML = `
          <div class="title">
            ${escapeHtml(alias)}
            ${banned ? '<span class="pill">banned</span>' : ''}
            ${disabledNow ? '<span class="pill">site suspended</span>' : ''}
            ${chatSuspNow ? '<span class="pill">chat suspended</span>' : ''}
            <span class="pill">${escapeHtml(targetRole)}</span>
          </div>
          <div class="desc">
            ${escapeHtml(d.email || "")}
            • warnings: ${escapeHtml(d.warnings || 0)}
          </div>
        `;

        const actions = document.createElement("div");
        actions.style.marginTop = "8px";
        actions.style.display = "flex";
        actions.style.gap = "8px";
        actions.style.flexWrap = "wrap";

        // Permission gate: can this actor touch this target?
        targetUidTemp = targetUid;
        const allowed = canModerateTarget(actorRole, targetRole);

        // contributors should not see moderation controls
        if (actorRole === "contributor") {
          // no actions
        } else {
          // warn/chat/site suspend available ONLY if allowed
          if (allowed){
            const b1 = document.createElement("button");
            b1.className = "btn";
            b1.textContent = "Warn";
            b1.onclick = async (e)=>{ e.stopPropagation(); await warnUser(targetUid, alias); await loadUsersForAdmin(); };
            actions.appendChild(b1);

            const b2 = document.createElement("button");
            b2.className = "btn";
            b2.textContent = chatSuspNow ? "Resume Chat" : "Suspend Chat";
            b2.onclick = async (e)=>{ e.stopPropagation(); await toggleChatSuspend(targetUid, alias); await loadUsersForAdmin(); };
            actions.appendChild(b2);

            const b3 = document.createElement("button");
            b3.className = "btn danger";
            b3.textContent = disabledNow ? "Unsuspend Site" : "Suspend Site";
            b3.onclick = async (e)=>{ e.stopPropagation(); await toggleSiteSuspend(targetUid, alias); await loadUsersForAdmin(); };
            actions.appendChild(b3);
          }

          // ban + change role = ADMIN ONLY
          if (isAdminOnly()){
            const b4 = document.createElement("button");
            b4.className = "btn danger";
            b4.textContent = banned ? "Unban" : "Ban";
            b4.onclick = async (e)=>{ e.stopPropagation(); await toggleBanUser(targetUid, alias); await loadUsersForAdmin(); };
            actions.appendChild(b4);

            const b5 = document.createElement("button");
            b5.className = "btn";
            b5.textContent = "Change role";
            b5.onclick = async (e)=>{ e.stopPropagation(); await changeUserRole(targetUid, alias, targetRole); await loadUsersForAdmin(); };
            actions.appendChild(b5);
          }
        }

        if (actions.childNodes.length) el.appendChild(actions);
        list.appendChild(el);
      });
    }

    /***********************
     * Content editing (simple prompts)
     ***********************/
    function canEditContent(){
      return rankOf(currentUserDoc?.role) >= rankOf("contributor");
    }

    $("btnAddLink").addEventListener("click", async () => {
      if (!canEditContent()) return alert("Not allowed.");
      if (!activeBrandId) return alert("Open a category first.");

      const title = prompt("Link title");
      if (!title) return;
      const url = prompt("URL (include https://)");
      if (!url) return;
      const desc = prompt("Description (optional)") || "";

      const ref = db.collection("brands").doc(activeBrandId);
      const snap = await ref.get();
      const d = snap.exists ? snap.data() : {};
      const links = Array.isArray(d.links) ? d.links : [];
      links.push({ title, url, desc });

      await ref.set({ links, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
      await openBrand(activeBrandId);
    });

    $("btnAddUtility").addEventListener("click", async () => {
      if (!canEditContent()) return alert("Not allowed.");
      const name = prompt("Utility name");
      if (!name) return;
      const url = prompt("URL (include https://)");
      if (!url) return;
      const desc = prompt("Description (optional)") || "";
      const id = name.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"").slice(0,60) || ("util-" + Date.now());

      await db.collection("utilities").doc(id).set({
        name, url, desc,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge:true });

      await loadUtilities();
    });

    $("btnAddEvent").addEventListener("click", async () => {
      if (!canEditContent()) return alert("Not allowed.");
      const title = prompt("Event title");
      if (!title) return;
      const date = prompt("Date (YYYY-MM-DD)");
      if (!date) return;
      const location = prompt("Location (optional)") || "";
      const id = "evt-" + Date.now();

      await db.collection("events").doc(id).set({
        title, date, location,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge:true });

      await loadEvents();
    });

    /***********************
     * Chat access enforcement (client-side)
     ***********************/
    function chatAllowed(){
      return !isActiveSuspension(currentUserDoc?.chatSuspendedUntil);
    }

    function updateChatNotices(){
      const suspended = isActiveSuspension(currentUserDoc?.chatSuspendedUntil);
      $("memberChatNotice").textContent = suspended ? "Your chat is suspended right now." : "";
      $("staffChatNotice").textContent = suspended ? "Your chat is suspended right now." : "";

      $("btnSendMember").disabled = suspended;
      $("memberChatInput").disabled = suspended;

      $("btnSendStaff").disabled = suspended;
      $("staffChatInput").disabled = suspended;
    }

    /***********************
     * Auth state handler
     ***********************/
    auth.onAuthStateChanged(async (user) => {
      if (!user){
        currentUser = null;
        currentUserDoc = null;

        authCard.style.display = "block";
        appGrid.style.display = "none";
        topbar.style.display = "none";
        footer.style.display = "none";

        setTabsEnabled(false);
        setView("homeView");
        return;
      }

      currentUser = user;

      // Ensure docs exist
      const uref = await ensureUserDoc(user);
      const usnap = await uref.get();
      currentUserDoc = usnap.data() || {};

      // Enforce bans/suspensions
      if (currentUserDoc.banned){
        alert("You are banned.");
        await auth.signOut();
        return;
      }

      if (currentUserDoc.disabled || isActiveSuspension(currentUserDoc.disabledUntil)){
        alert("Your account is suspended from the site right now.");
        await auth.signOut();
        return;
      }

      // Show app
      authCard.style.display = "none";
      appGrid.style.display = "grid";
      topbar.style.display = "block";
      footer.style.display = "block";

      $("userName").textContent = currentUserDoc.alias || (user.email || "user").split("@")[0];
      $("userEmail").textContent = user.email || "";

      // settings
      await loadSettings(user.uid);

      // permissions
      setTabsEnabled(true);
      applyPermissions();
      updateChatNotices();

      // data
      await loadOverview();
      await loadBrands();
      await loadUtilities();
      await loadEvents();
      listenMemberChat();

      // staff chat only for contributor+
      if (rankOf(currentUserDoc.role) >= rankOf("contributor")){
        listenStaffChat();
      } else {
        if (unsubStaffChat) unsubStaffChat();
        $("staffChatBox").innerHTML = `<div class="muted small">Not authorized.</div>`;
      }

      // admin view loads if allowed to view
      if (["admin","co-admin","manager"].includes(normRole(currentUserDoc.role))){
        await loadTopStats(10);
        await loadUsersForAdmin();
        await loadModLogs();
      }

      // default view
      setView("homeView");
    });

    // Default auto theme before login
    if (systemPrefersDark()) document.documentElement.setAttribute("data-theme","dark");
  </script>

  <!-- IMPORTANT:
    This is UI-only security. You MUST add Firestore Rules to enforce:
    - only admin can ban / change role / moderate staff
    - managers/co-admin can only moderate members
    - contributors can only read/write staffChat (and cannot moderate)
  -->
</body>
</html>
